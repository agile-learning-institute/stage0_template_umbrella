# docker-compose.yaml for {{info.name}} developers edition
services:
  ##################################
  # Welcome Service
  ##################################
  welcome:
    image: {{org.docker_host}}/{{org.docker_org}}/{{info.slug}}:latest
    ports:
      - 80:80
    profiles:
      - all

  ##################################
  # Custom Runbook API Service (Deployed Profile)
  ##################################
  runbook-api:
    image: {{org.docker_host}}/{{org.docker_org}}/{{info.slug}}_runbook_api:latest
    container_name: runbook_api
    working_dir: /opt/stage0/runner
    restart: unless-stopped
    ports:
      - "{{info.base_port + 0}}:{{info.base_port + 0}}"
    environment:
      API_PORT: {{info.base_port + 0}}
      RUNBOOKS_DIR: ./runbooks
      ENABLE_LOGIN: "true"
      LOGGING_LEVEL: "INFO"
      JWT_SECRET: ${JWT_SECRET}
      GITHUB_TOKEN: ${GITHUB_TOKEN}
      SSH_KEY: ${SSH_KEY}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8182/metrics')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    profiles:
      - all
      - runbook

  runbook-spa:
    image: ghcr.io/agile-learning-institute/stage0_runbook_spa:latest
    container_name: runbook_spa
    restart: unless-stopped
    ports:
      - "{{info.base_port + 1}}:80"
    environment:
      API_HOST: runbook-api
      API_PORT: {{info.base_port + 0}}
      IDP_LOGIN_URI: ${IDP_LOGIN_URI:-http://localhost:{{info.base_port + 1}}/login}
    depends_on:
      runbook-api:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    profiles:
      - all
      - runbook

  ##################################
  # Backing Services 
  ##################################
  # MongoDB backing service 
  mongodb:
    image: mongo:7.0.5
    ports:
      - 27017:27017
    extra_hosts:
      - "mongodb:127.0.0.1"
    healthcheck:
      test: echo "db.runCommand('ping')" | mongosh --port 27017 --quiet
      interval: 5s
      timeout: 30s
      start_period: 0s
      retries: 3
    command: ["--bind_ip_all", "--port", "27017"]
    profiles:
      - all
      - mongodb

  ##################################
  # Mongo Database Configuration Utilities
  ##################################
  mongodb_api:
    image: {{org.docker_host}}/{{org.docker_org}}/{{info.slug}}_mongodb_api:latest
    restart: no
    ports:
      - {{info.base_port + 2}}:{{info.base_port + 2}}
    environment:
      MONGO_CONNECTION_STRING: mongodb://mongodb:27017/
      MONGODB_REQUIRE_TLS: False
      MONGO_DB_NAME: {{info.db_name}}
      AUTO_PROCESS: True
      LOAD_TEST_DATA: True
      API_PORT: {{info.base_port + 2}}
      SPA_PORT: {{info.base_port + 3}}
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:8081/api/config/').read()\" || exit 1"]
      interval: 5s
      timeout: 30s
      start_period: 0s
      retries: 3
    depends_on:
      mongodb:
        condition: service_healthy
    profiles:
      - all
      - mongodb
      - dashboard
      - dashboard-api

  mongodb_spa:
    image: ghcr.io/agile-learning-institute/mongodb_configurator_spa:latest
    restart: no
    ports:
      - {{info.base_port + 3}}:{{info.base_port + 3}}
    environment:
      API_HOST: mongodb_api
      API_PORT: {{info.base_port + 2}}
      SPA_PORT: {{info.base_port + 3}}
    depends_on:
      mongodb_api:
        condition: service_started
    profiles:
      - all
      - mongodb

  ##################################
  # Template Microservice 
  ##################################
  # template_api:
  #   image: {{org.docker_host}}/{{org.docker_org}}/{{info.slug}}_template_api:latest
  #   restart: no
  #   ports:
  #     - 8184:8184
  #   environment:
  #     MONGO_CONNECTION_STRING: mongodb://mongodb:27017/
  #     MONGODB_REQUIRE_TLS: False
  #     MONGO_DB_NAME: {{info.db_name}}
  #     ENABLE_LOGIN: "true"
  #     LOGGING_LEVEL: "INFO"
  #     JWT_SECRET: ${JWT_SECRET}
  #     TEMPLATE_API_PORT: 8184
  #     TEMPLATE_SPA_PORT: 8185
  #   depends_on:
  #     mongodb_api:
  #       condition: service_healthy
  #   profiles:
  #     - all
  #     - template-api
  #     - template

  # template_spa:
  #   image: {{org.docker_host}}/{{org.docker_org}}/{{info.slug}}_template_spa:latest
  #   restart: no
  #   ports:
  #     - 8185:80
  #   environment:
  #     API_HOST: template_api
  #     API_PORT: 8184
  #     SPA_PORT: 8185
  #   depends_on:
  #     template_api:
  #       condition: service_started
  #   profiles:
  #     - all
  #     - template
